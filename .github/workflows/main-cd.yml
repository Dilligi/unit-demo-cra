name: CD

on:
    push:
        tags:
        - 'v[0-9]+'

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
              with:
                token: ${{ secrets.REPO_SECRET }}

            - uses: actions/setup-node@v1
              with:
                node-version: '16.x'
      
            - name: Install dependencies and buld app
              run: |
                npm ci --force
                npm run build

            - name: Find previous release tag
              id: get_previous_tag
              run: |
                CURRENT_TAG=${{github.ref_name}}
                PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^)
                echo ::set-output name=previous_tag::$(git rev-parse $PREVIOUS_TAG) 
                echo CURRENT_TAG

            - name: Generate changelog
              id: generate_changelog
              run: |
                git log --pretty=format:"- hash: %h, name: %s" ${{ steps.get_previous_tag.outputs.previous_tag }}..HEAD > changelog.txt
                echo ::set-output name=changelog::$(cat changelog.txt)
                echo ${{ steps.get_previous_tag.outputs.previous_tag }}

            - name: Create release
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: ${{ github.ref_name }}
                  body: ${{ steps.generate_changelog.outputs.changelog }}
                  draft: false
                  prerelease: false

